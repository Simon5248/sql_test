<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è³‡æ–™è¡¨æ¬„ä½æŸ¥è©¢</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <h2>ğŸ“Š B2Bè³‡æ–™è¡¨æ¬„ä½ä¸­è‹±å°ç…§æŸ¥è©¢ç³»çµ±</h2>

  <input type="text" id="searchInput" placeholder="ğŸ” è«‹è¼¸å…¥è³‡æ–™è¡¨åç¨±é—œéµå­—ï¼ˆè‹±æ–‡ï¼‰">
  <input type="text" id="searchInput2" placeholder="ğŸ” è«‹è¼¸å…¥æ¬„ä½åç¨±é—œéµå­—ï¼ˆè‹±æ–‡ï¼‰">
  <input type="text" id="searchInput4" placeholder="ğŸ” è«‹è¼¸å…¥è³‡æ–™è¡¨ä¸­æ–‡èªªæ˜é—œéµå­—ï¼ˆä¸­æ–‡ï¼‰">
  <input type="text" id="searchInput3" placeholder="ğŸ” è«‹è¼¸å…¥æ¬„ä½ä¸­æ–‡èªªæ˜é—œéµå­—ï¼ˆä¸­æ–‡ï¼‰">
  <div class="controls">
    <button class="btn" onclick="selectAllForSelect()">ğŸ” å…¨é¸ç‚º SELECT</button>
    <button class="btn" onclick="selectAllForWhere()">ğŸ¯ å…¨é¸ç‚º WHERE</button>
    <button class="btn" onclick="selectAllForBoth()">ğŸŸ§ å…¨é¸ç‚º SELECT + WHERE</button>
    <button class="btn" onclick="clearSelection()">âŒ æ¸…é™¤é¸æ“‡</button>
    <button class="btn" onclick="generateSQL()">âš¡ ç”Ÿæˆ SQL</button>
  </div>

  <table id="resultTable">
    <thead>
      <tr>
        <th>æ¬„ä½çµ„åˆé¸é …</th>
        <th>Schema åç¨±</th>
        <th>è³‡æ–™è¡¨åç¨±</th>
        <th>è³‡æ–™è¡¨èªªæ˜</th>
        <th>æ¬„ä½åç¨±</th>
        <th>æ¬„ä½èªªæ˜</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="queryResult" class="sql-section" style="display:none;">
    <div class="selection-info" id="selectionInfo"></div>
    
    <div class="sql-tabs">
      <button class="tab-btn active" onclick="showTab('select')">ğŸ“‹ SELECT</button>
      <button class="tab-btn" onclick="showTab('update')">ğŸ”„ UPDATE</button>
      <button class="tab-btn" onclick="showTab('insert')">â• INSERT</button>
    </div>

    <div id="selectTab" class="tab-content active">
      <button class="copy-btn" onclick="copySql('select')">ğŸ“‹ è¤‡è£½</button>
      <button class="copy-btn" onclick="downloadSql('select')">â¬‡ï¸ ä¸‹è¼‰</button>
      <strong>ğŸ” SELECT æŸ¥è©¢èªæ³•ï¼š</strong>
      <div id="selectSql"></div>
    </div>

    <div id="updateTab" class="tab-content">
      <button class="copy-btn" onclick="copySql('update')">ğŸ“‹ è¤‡è£½</button>
      <button class="copy-btn" onclick="downloadSql('update')">â¬‡ï¸ ä¸‹è¼‰</button>
      <strong>ğŸ”„ UPDATE æ›´æ–°èªæ³•ï¼š</strong>
      <div id="updateSql"></div>
    </div>

    <div id="insertTab" class="tab-content">
      <button class="copy-btn" onclick="copySql('insert')">ğŸ“‹ è¤‡è£½</button>
      <button class="copy-btn" onclick="downloadSql('insert')">â¬‡ï¸ ä¸‹è¼‰</button>
      <strong>â• INSERT æ’å…¥èªæ³•ï¼š</strong>
      <div id="insertSql"></div>
    </div>
  </div>

  <script>
    let data = [];
    const errorMessageDiv = document.createElement("div");
    errorMessageDiv.style.color = "red";
    const fetchWithTimeout = (url, timeout = 5000) => {
      return Promise.race([
        fetch(url),
        new Promise((_, reject) =>
          setTimeout(() => reject(new Error('Request timed out')), timeout)
        )
      ]);
    };

    // å…ˆå˜—è©¦å¾ API å–å¾—è³‡æ–™ï¼Œå¤±æ•—æ™‚å† fallback åˆ° data.json
    const API_URL = "https://your-api-endpoint.com/getSqlFields"; // è«‹æ›¿æ›ç‚ºå¯¦éš› API

    function loadDataFromJson() {
    fetchWithTimeout('data.json')
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(jsonData => {
        data = jsonData;
        console.log('Data loaded from data.json:', data);
      })
      .catch(error => {
        console.error('Error loading data from data.json:', error);
        errorMessageDiv.textContent = "âš ï¸ ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨æˆ–ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸ã€‚";
      });
    }

    fetchWithTimeout(API_URL)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(jsonData => {
        data = jsonData;
        console.log('Data loaded from API:', data);
      })
      .catch(error => {
        console.error('Error loading data from API, fallback to data.json:', error);
        loadDataFromJson();
      });

    const input = document.getElementById("searchInput");
    const input2 = document.getElementById("searchInput2");
    const input3 = document.getElementById("searchInput3");
    const input4 = document.getElementById("searchInput4");
    const tbody = document.querySelector("#resultTable tbody");
    const queryDiv = document.getElementById("queryResult");
    let currentMatched = [];
    let selectedFields = new Map(); // æ”¹ç”¨ Map ä¾†å„²å­˜æ¬„ä½è³‡è¨Šï¼Œkey: fieldName, value: {type, tableInfo}

    function renderTable(filteredData) {
      tbody.innerHTML = "";
      queryDiv.style.display = "none";
      selectedFields.clear();

      currentMatched = filteredData;

      if (currentMatched.length > 0) {
      currentMatched.forEach((row, index) => {
        const tr = document.createElement("tr");
        tr.className = "field-row";
        tr.dataset.index = index;

        // åŠ å…¥é¸æ“‡å™¨
        const selectorTd = document.createElement("td");
        const selector = document.createElement("button");
        selector.className = "field-selector";
        selector.textContent = "æœªé¸æ“‡";
        selector.dataset.field = row["æ¬„ä½åç¨±"];
        selector.dataset.table = row["è³‡æ–™è¡¨åç¨±"];
        selector.dataset.schema = row["Schema åç¨±"];
        selector.dataset.state = "none"; // none, select, where, both
        selector.addEventListener("click", handleFieldSelection);
        selectorTd.appendChild(selector);
        tr.appendChild(selectorTd);

        // åŠ å…¥å…¶ä»–æ¬„ä½
        for (const key in row) {
        const td = document.createElement("td");
        td.textContent = row[key];
        tr.appendChild(td);
        }

        tbody.appendChild(tr);
      });
      }
    }

    function filterData() {
      // è™•ç†é€—è™Ÿåˆ†å‰²çš„é—œéµå­—
      const getKeywords = (inputValue) => {
        return inputValue.trim()
          .split(',')
          .map(kw => kw.trim().toLowerCase())
          .filter(kw => kw);
      };

      const keywords1 = getKeywords(input.value);   // å°æ‡‰ã€Œè³‡æ–™è¡¨åç¨±ã€
      const keywords2 = getKeywords(input2.value);  // å°æ‡‰ã€Œæ¬„ä½åç¨±ã€  
      const keywords3 = getKeywords(input3.value);  // å°æ‡‰ã€Œæ¬„ä½èªªæ˜ã€
      const keywords4 = getKeywords(input4.value);  // å°æ‡‰ã€Œè³‡æ–™è¡¨èªªæ˜ã€

      let filtered = data;

      // 7ç¨®å¯èƒ½çš„çµ„åˆï¼ˆ2^3 - 1ï¼Œæ’é™¤å…¨ç©ºçš„æƒ…æ³ï¼‰
      
      const filters = [
      { value: keywords1, key: "è³‡æ–™è¡¨åç¨±" },
      { value: keywords2, key: "æ¬„ä½åç¨±" },
      { value: keywords3, key: "æ¬„ä½èªªæ˜" },
      { value: keywords4, key: "è³‡æ–™è¡¨èªªæ˜"}
      ];
      filtered = data.filter(row =>
        filters.every(f =>
          f.value.length === 0 ||
          f.value.some(kw => {
            const cell = (row[f.key] || "").toString().trim().toLowerCase();
            return cell.includes(kw);
          })
        )
      );
      // å¦‚æœæ‰€æœ‰è¼¸å…¥æ¡†éƒ½æ˜¯ç©ºçš„ï¼Œfiltered ä¿æŒç‚ºåŸå§‹ data
      
      renderTable(filtered);
    }

    input.addEventListener("input", filterData);
    input2.addEventListener("input", filterData);
    input3.addEventListener("input", filterData);
    input4.addEventListener("input", filterData);

    function handleFieldSelection(e) {
      e.stopPropagation();
      const selector = e.target;
      const fieldName = selector.dataset.field;
      const tableName = selector.dataset.table;
      const schemaName = selector.dataset.schema;
      const row = selector.closest("tr");
      const fieldKey = `${schemaName}.${tableName}.${fieldName}`;

      // ç‹€æ…‹å¾ªç’°ï¼šnone â†’ select â†’ where â†’ both â†’ joinkey â†’ joinkeysel â†’ joinkeyselwhere â†’ none
      switch (selector.dataset.state) {
        case "none":
          selector.dataset.state = "select";
          selector.textContent = "SELECT";
          selector.className = "field-selector select";
          selectedFields.set(fieldKey, {
            type: "select",
            fieldName, tableName, schemaName,
            description: getFieldDescription(fieldName, tableName, schemaName)
          });
          row.classList.add("selected-select");
          row.classList.remove("selected-where", "selected-both", "selected-joinkey", "selected-joinkeysel", "selected-joinkeyselwhere");
          break;
        case "select":
          selector.dataset.state = "where";
          selector.textContent = "WHERE";
          selector.className = "field-selector where";
          selectedFields.set(fieldKey, {
            type: "where",
            fieldName, tableName, schemaName,
            description: getFieldDescription(fieldName, tableName, schemaName)
          });
          row.classList.add("selected-where");
          row.classList.remove("selected-select", "selected-both", "selected-joinkey", "selected-joinkeysel", "selected-joinkeyselwhere");
          break;
        case "where":
          selector.dataset.state = "both";
          selector.textContent = "SELECT+WHERE";
          selector.className = "field-selector both";
          selectedFields.set(fieldKey, {
            type: "both",
            fieldName, tableName, schemaName,
            description: getFieldDescription(fieldName, tableName, schemaName)
          });
          row.classList.add("selected-both");
          row.classList.remove("selected-select", "selected-where", "selected-joinkey", "selected-joinkeysel", "selected-joinkeyselwhere");
          break;
        case "both":
          selector.dataset.state = "joinkey";
          selector.textContent = "JOIN KEY";
          selector.className = "field-selector joinkey";
          selectedFields.set(fieldKey, {
            type: "joinkey",
            fieldName, tableName, schemaName,
            description: getFieldDescription(fieldName, tableName, schemaName)
          });
          row.classList.add("selected-joinkey");
          row.classList.remove("selected-select", "selected-where", "selected-both", "selected-joinkeysel", "selected-joinkeyselwhere");
          break;
        case "joinkey":
          selector.dataset.state = "joinkeysel";
          selector.textContent = "JOIN KEY+SELECT";
          selector.className = "field-selector joinkeysel";
          selectedFields.set(fieldKey, {
            type: "joinkeysel",
            fieldName, tableName, schemaName,
            description: getFieldDescription(fieldName, tableName, schemaName)
          });
          row.classList.add("selected-joinkeysel");
          row.classList.remove("selected-select", "selected-where", "selected-both", "selected-joinkey", "selected-joinkeyselwhere");
          break;
        case "joinkeysel":
          selector.dataset.state = "joinkeyselwhere";
          selector.textContent = "JOIN KEY+SELECT+WHERE";
          selector.className = "field-selector joinkeyselwhere";
          selectedFields.set(fieldKey, {
            type: "joinkeyselwhere",
            fieldName, tableName, schemaName,
            description: getFieldDescription(fieldName, tableName, schemaName)
          });
          row.classList.add("selected-joinkeyselwhere");
          row.classList.remove("selected-select", "selected-where", "selected-both", "selected-joinkey", "selected-joinkeysel");
          break;
        case "joinkeyselwhere":
          selector.dataset.state = "none";
          selector.textContent = "æœªé¸æ“‡";
          selector.className = "field-selector";
          selectedFields.delete(fieldKey);
          row.classList.remove("selected-select", "selected-where", "selected-both", "selected-joinkey", "selected-joinkeysel", "selected-joinkeyselwhere");
          break;
      }
    }

    function selectAllForSelect() {
      const selectors = document.querySelectorAll(".field-selector");
      selectors.forEach(selector => {
        const fieldName = selector.dataset.field;
        const tableName = selector.dataset.table;
        const schemaName = selector.dataset.schema;
        const row = selector.closest("tr");
        const fieldKey = `${schemaName}.${tableName}.${fieldName}`;
        
        // æ¸…é™¤ä¹‹å‰çš„ç‹€æ…‹
        row.classList.remove("selected-where");
        
        // è¨­ç½®ç‚º SELECT
        selector.dataset.state = "select";
        selector.textContent = "SELECT";
        selector.className = "field-selector select";
        selectedFields.set(fieldKey, {
          type: "select",
          fieldName: fieldName,
          tableName: tableName,
          schemaName: schemaName,
          description: getFieldDescription(fieldName, tableName, schemaName)
        });
        row.classList.add("selected-select");
      });
    }

    function selectAllForWhere() {
      const selectors = document.querySelectorAll(".field-selector");
      selectors.forEach(selector => {
        const fieldName = selector.dataset.field;
        const tableName = selector.dataset.table;
        const schemaName = selector.dataset.schema;
        const row = selector.closest("tr");
        const fieldKey = `${schemaName}.${tableName}.${fieldName}`;
        
        // æ¸…é™¤ä¹‹å‰çš„ç‹€æ…‹
        row.classList.remove("selected-select");
        
        // è¨­ç½®ç‚º WHERE
        selector.dataset.state = "where";
        selector.textContent = "WHERE";
        selector.className = "field-selector where";
        selectedFields.set(fieldKey, {
          type: "where",
          fieldName: fieldName,
          tableName: tableName,
          schemaName: schemaName,
          description: getFieldDescription(fieldName, tableName, schemaName)
        });
        row.classList.add("selected-where");
      });
    }

    function selectAllForBoth() {
      const selectors = document.querySelectorAll(".field-selector");
      selectors.forEach(selector => {
        const fieldName = selector.dataset.field;
        const tableName = selector.dataset.table;
        const schemaName = selector.dataset.schema;
        const row = selector.closest("tr");
        const fieldKey = `${schemaName}.${tableName}.${fieldName}`;
        
        // è¨­ç½®ç‚º BOTH (åŒæ™‚ SELECT å’Œ WHERE)
        selector.dataset.state = "both";
        selector.textContent = "SELECT+WHERE";
        selector.className = "field-selector both";
        selectedFields.set(fieldKey, {
          type: "both",
          fieldName: fieldName,
          tableName: tableName,
          schemaName: schemaName,
          description: getFieldDescription(fieldName, tableName, schemaName)
        });
        row.classList.add("selected-both");
        row.classList.remove("selected-select", "selected-where");
      });
    }

    function clearSelection() {
      const selectors = document.querySelectorAll(".field-selector");
      selectors.forEach(selector => {
        const row = selector.closest("tr");
        selector.dataset.state = "none";
        selector.textContent = "æœªé¸æ“‡";
        selector.className = "field-selector";
        row.classList.remove("selected-select", "selected-where");
      });
      selectedFields.clear();
      queryDiv.style.display = "none";
    }

    function generateSQL() {
      if (selectedFields.size === 0) {
        alert("è«‹å…ˆé¸æ“‡è¦æ“ä½œçš„æ¬„ä½ï¼");
        return;
      }

      // æŒ‰è³‡æ–™è¡¨åˆ†çµ„
      const tableGroups = {};
      selectedFields.forEach((fieldInfo, fieldKey) => {
        const tableKey = `${fieldInfo.schemaName}.${fieldInfo.tableName}`;
        if (!tableGroups[tableKey]) {
          tableGroups[tableKey] = {
            schemaName: fieldInfo.schemaName,
            tableName: fieldInfo.tableName,
            selectFields: [],
            whereFields: [],
            joinKeyFields: [],
            joinKeySelectFields: []
          };
        }
        if (fieldInfo.type === "select") {
          tableGroups[tableKey].selectFields.push(fieldInfo);
        } else if (fieldInfo.type === "where") {
          tableGroups[tableKey].whereFields.push(fieldInfo);
        } else if (fieldInfo.type === "both") {
          tableGroups[tableKey].selectFields.push(fieldInfo);
          tableGroups[tableKey].whereFields.push(fieldInfo);
        } else if (fieldInfo.type === "joinkey") {
          tableGroups[tableKey].joinKeyFields.push(fieldInfo);
        } else if (fieldInfo.type === "joinkeysel") {
          tableGroups[tableKey].joinKeyFields.push(fieldInfo);
          tableGroups[tableKey].selectFields.push(fieldInfo);
          tableGroups[tableKey].joinKeySelectFields.push(fieldInfo);
        } else if (fieldInfo.type === "joinkeyselwhere") {
          tableGroups[tableKey].joinKeyFields.push(fieldInfo);
          tableGroups[tableKey].selectFields.push(fieldInfo);
          tableGroups[tableKey].whereFields.push(fieldInfo);
          tableGroups[tableKey].joinKeySelectFields.push(fieldInfo);
        }
      });

      const tableCount = Object.keys(tableGroups).length;
      updateSelectionInfo(tableGroups);

      if (tableCount === 1) {
        // å–®ä¸€è³‡æ–™è¡¨
        const tableKey = Object.keys(tableGroups)[0];
        const tableGroup = tableGroups[tableKey];
        generateSingleTableSQL(tableGroup);
      } else {
        // å¤šè¡¨æ™‚ï¼Œéœ€åˆ¤æ–·æ˜¯å¦æœ‰ joinKey æˆ– joinKeysel
        let hasJoinKey = false;
        Object.values(tableGroups).forEach(group => {
          if (group.joinKeyFields.length > 0) hasJoinKey = true;
        });

        if (hasJoinKey) {
          generateJoinSQL(tableGroups);
        } else {
          generateMultiTableSQL(tableGroups);
        }
      }

      queryDiv.style.display = "block";
    }

    function updateSelectionInfo(tableGroups) {
      let infoHtml = "";
      let totalSelect = 0;
      let totalWhere = 0;

      Object.keys(tableGroups).forEach(tableKey => {
        const group = tableGroups[tableKey];
        totalSelect += group.selectFields.length;
        totalWhere += group.whereFields.length;
        
        infoHtml += `<div><strong>è³‡æ–™è¡¨ï¼š${group.schemaName}.${group.tableName}</strong><br>`;
        
        if (group.selectFields.length > 0) {
          infoHtml += `<span class="select-fields">SELECT æ¬„ä½ (${group.selectFields.length})ï¼š${group.selectFields.map(f => `<code>${f.fieldName}</code>`).join(", ")}</span><br>`;
        }
        if (group.whereFields.length > 0) {
          infoHtml += `<span class="where-fields">WHERE æ¢ä»¶ (${group.whereFields.length})ï¼š${group.whereFields.map(f => `<code>${f.fieldName}</code>`).join(", ")}</span><br>`;
        }
        infoHtml += `</div><br>`;
      });

      infoHtml = `<div><strong>ç¸½è¨ˆï¼šSELECT (${totalSelect}) / WHERE (${totalWhere})</strong></div><br>` + infoHtml;
      document.getElementById("selectionInfo").innerHTML = infoHtml;
    }

    function generateSingleTableSQL(tableGroup) {
      const fullTableName = `[${tableGroup.schemaName}].[${tableGroup.tableName}]`;
      
      // SELECT SQL
      let selectSql = "";
      if (tableGroup.selectFields.length > 0) {
        const columns = tableGroup.selectFields.map(field => `    [${field.fieldName}] /* ${field.description} */`).join(",\n");
        selectSql = `SELECT\n${columns}\nFROM ${fullTableName}`;
        
        if (tableGroup.whereFields.length > 0) {
          const whereConditions = tableGroup.whereFields.map(field => `    [${field.fieldName}] = ? /* ${field.description} */`).join(" AND\n");
          selectSql += `\nWHERE\n${whereConditions}`;
        }
        selectSql += ";";
      } else {
        selectSql = "-- è«‹å…ˆé¸æ“‡ SELECT æ¬„ä½";
      }

      // UPDATE SQL
      let updateSql = "";
      if (tableGroup.selectFields.length > 0) {
        const updateSets = tableGroup.selectFields.map(field => `    [${field.fieldName}] = ? /* ${field.description} */`).join(",\n");
        updateSql = `UPDATE ${fullTableName}\nSET\n${updateSets}`;
        
        if (tableGroup.whereFields.length > 0) {
          const whereConditions = tableGroup.whereFields.map(field => `    [${field.fieldName}] = ? /* ${field.description} */`).join(" AND\n");
          updateSql += `\nWHERE\n${whereConditions}`;
        } else {
          updateSql += `\nWHERE\n    /* è«‹åŠ å…¥é©ç•¶çš„æ¢ä»¶æˆ–é¸æ“‡ WHERE æ¬„ä½ */\n    [ä¸»éµæ¬„ä½] = ?`;
        }
        updateSql += ";";
      } else {
        updateSql = "-- è«‹å…ˆé¸æ“‡è¦æ›´æ–°çš„æ¬„ä½ (ä½¿ç”¨ SELECT é¸é …)";
      }

      // INSERT SQL
      let insertSql = "";
      if (tableGroup.selectFields.length > 0) {
        const insertColumns = tableGroup.selectFields.map(field => `    [${field.fieldName}]`).join(",\n");
        const insertValues = tableGroup.selectFields.map(field => `    ? /* ${field.description} */`).join(",\n");
        insertSql = `INSERT INTO ${fullTableName}\n(\n${insertColumns}\n)\nVALUES\n(\n${insertValues}\n);`;
      } else {
        insertSql = "-- è«‹å…ˆé¸æ“‡è¦æ’å…¥çš„æ¬„ä½ (ä½¿ç”¨ SELECT é¸é …)";
      }

      document.getElementById("selectSql").innerHTML = `<pre>${selectSql}</pre>`;
      document.getElementById("updateSql").innerHTML = `<pre>${updateSql}</pre>`;
      document.getElementById("insertSql").innerHTML = `<pre>${insertSql}</pre>`;
    }

    function generateMultiTableSQL(tableGroups) {
      let selectSqlHtml = '<div class="warning">âš ï¸ å¤šå€‹è³‡æ–™è¡¨è¢«é¸ä¸­ï¼Œä»¥ä¸‹ç‚ºå„è³‡æ–™è¡¨çš„ç¨ç«‹ SQL èªæ³•ï¼š</div>';
      let updateSqlHtml = '<div class="warning">âš ï¸ å¤šå€‹è³‡æ–™è¡¨è¢«é¸ä¸­ï¼Œä»¥ä¸‹ç‚ºå„è³‡æ–™è¡¨çš„ç¨ç«‹ SQL èªæ³•ï¼š</div>';
      let insertSqlHtml = '<div class="warning">âš ï¸ å¤šå€‹è³‡æ–™è¡¨è¢«é¸ä¸­ï¼Œä»¥ä¸‹ç‚ºå„è³‡æ–™è¡¨çš„ç¨ç«‹ SQL èªæ³•ï¼š</div>';

      Object.keys(tableGroups).forEach(tableKey => {
        const group = tableGroups[tableKey];
        const fullTableName = `[${group.schemaName}].[${group.tableName}]`;
        
        // SELECT
        selectSqlHtml += `<div class="table-section">`;
        selectSqlHtml += `<div class="table-title">ğŸ“‹ ${group.schemaName}.${group.tableName}</div>`;
        
        if (group.selectFields.length > 0) {
          const columns = group.selectFields.map(field => `    [${field.fieldName}]`).join(",\n");
          let sql = `SELECT\n${columns}\nFROM ${fullTableName}`;
          
          if (group.whereFields.length > 0) {
            const whereConditions = group.whereFields.map(field => `    [${field.fieldName}] = ? /* ${field.description} */`).join(" AND\n");
            sql += `\nWHERE\n${whereConditions}`;
          }
          sql += ";";
          selectSqlHtml += `<pre>${sql}</pre>`;
        } else {
          selectSqlHtml += `<pre>-- æ­¤è³‡æ–™è¡¨æ²’æœ‰é¸æ“‡ SELECT æ¬„ä½</pre>`;
        }
        selectSqlHtml += `</div>`;

        // UPDATE
        updateSqlHtml += `<div class="table-section">`;
        updateSqlHtml += `<div class="table-title">ğŸ”„ ${group.schemaName}.${group.tableName}</div>`;
        
        if (group.selectFields.length > 0) {
          const updateSets = group.selectFields.map(field => `    [${field.fieldName}] = ? /* ${field.description} */`).join(",\n");
          let sql = `UPDATE ${fullTableName}\nSET\n${updateSets}`;
          
          if (group.whereFields.length > 0) {
            const whereConditions = group.whereFields.map(field => `    [${field.fieldName}] = ? /* ${field.description} */`).join(" AND\n");
            sql += `\nWHERE\n${whereConditions}`;
          } else {
            sql += `\nWHERE\n    /* è«‹åŠ å…¥é©ç•¶çš„æ¢ä»¶æˆ–é¸æ“‡ WHERE æ¬„ä½ */\n    [ä¸»éµæ¬„ä½] = ?`;
          }
          sql += ";";
          updateSqlHtml += `<pre>${sql}</pre>`;
        } else {
          updateSqlHtml += `<pre>-- æ­¤è³‡æ–™è¡¨æ²’æœ‰é¸æ“‡è¦æ›´æ–°çš„æ¬„ä½</pre>`;
        }
        updateSqlHtml += `</div>`;

        // INSERT
        insertSqlHtml += `<div class="table-section">`;
        insertSqlHtml += `<div class="table-title">â• ${group.schemaName}.${group.tableName}</div>`;
        
        if (group.selectFields.length > 0) {
          const insertColumns = group.selectFields.map(field => `    [${field.fieldName}]`).join(",\n");
          const insertValues = group.selectFields.map(field => `    ? /* ${field.description} */`).join(",\n");
          const sql = `INSERT INTO ${fullTableName}\n(\n${insertColumns}\n)\nVALUES\n(\n${insertValues}\n);`;
          insertSqlHtml += `<pre>${sql}</pre>`;
        } else {
          insertSqlHtml += `<pre>-- æ­¤è³‡æ–™è¡¨æ²’æœ‰é¸æ“‡è¦æ’å…¥çš„æ¬„ä½</pre>`;
        }
        insertSqlHtml += `</div>`;
      });

      document.getElementById("selectSql").innerHTML = selectSqlHtml;
      document.getElementById("updateSql").innerHTML = updateSqlHtml;
      document.getElementById("insertSql").innerHTML = insertSqlHtml;
    }

    function generateJoinSQL(tableGroups) {
      const tables = Object.values(tableGroups);
      if (tables.length < 2) {
        document.getElementById("selectSql").innerHTML = "<pre>-- è«‹é¸æ“‡å…©å€‹ä»¥ä¸Šè³‡æ–™è¡¨ä¸¦æŒ‡å®š JOIN KEY</pre>";
        document.getElementById("insertSql").innerHTML = "";
        return;
      }

      const fromTable = tables[0]; // <--- åŠ é€™ä¸€è¡Œ
      const whereConds = []; // Initialize whereConds as an empty array
      tables.forEach(table => {
        table.whereFields.forEach(field => {
          whereConds.push(`[${table.tableName}].[${field.fieldName}] = ? /* ${field.description} */`);
        });
      });

      // 1. æ”¶é›†æ‰€æœ‰ join key æ¬„ä½ï¼Œä¾æ¬„ä½åç¨±åˆ†çµ„
      const joinKeyMap = {};
      tables.forEach(table => {
        table.joinKeyFields.forEach(jk => {
          if (!joinKeyMap[jk.fieldName]) joinKeyMap[jk.fieldName] = [];
          joinKeyMap[jk.fieldName].push(table.tableName);
        });
      });

      // 2. åªå–åœ¨æ‰€æœ‰è³‡æ–™è¡¨éƒ½å‡ºç¾çš„ join key æ¬„ä½
      const validJoinKeys = Object.keys(joinKeyMap)
        .filter(fieldName => joinKeyMap[fieldName].length === tables.length);

      // æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ join key
      if (validJoinKeys.length === 0) {
        document.getElementById("selectSql").innerHTML = "<pre>-- ç„¡æœ‰æ•ˆçš„ JOIN KEYï¼Œè«‹æª¢æŸ¥é¸æ“‡çš„æ¬„ä½</pre>";
        document.getElementById("updateSql").innerHTML = "<pre>-- ç„¡æœ‰æ•ˆçš„ JOIN KEYï¼Œç„¡æ³•ç”Ÿæˆ UPDATE èªæ³•</pre>";
        return;
      }

      // 3. çµ„åˆ SELECT æ¬„ä½
      let selectCols = [];
      tables.forEach(table => {
        table.selectFields.forEach(f => {
          selectCols.push(`[${table.tableName}].[${f.fieldName}]`);
        });
      });

      // 6. çµ„åˆ SELECT SQL
      const joinClauses = []; // Initialize joinClauses as an empty array
      for (let i = 1; i < tables.length; i++) {
        const leftTable = tables[i - 1];
        const rightTable = tables[i];
        const commonJoinKeys = validJoinKeys.map(fieldName =>
          `[${leftTable.tableName}].[${fieldName}] = [${rightTable.tableName}].[${fieldName}]`
        ).join(" AND ");
        if (commonJoinKeys) {
          joinClauses.push(`JOIN [${rightTable.schemaName}].[${rightTable.tableName}] ON ${commonJoinKeys}`);
        }
      }
      let sql = "";
      if (selectCols.length > 0) {
        sql = `SELECT\n  ${selectCols.join(",\n  ")}\nFROM [${fromTable.schemaName}].[${fromTable.tableName}]\n`;
        if (joinClauses.length > 0) sql += joinClauses.join("\n") + "\n";
        if (whereConds.length > 0) sql += "WHERE\n  " + whereConds.join("\n  AND ") + "\n";
        sql += ";";
      } else {
        sql = "-- è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ¬„ä½ç‚º SELECT";
      }

      document.getElementById("selectSql").innerHTML = `<pre>${sql}</pre>`;

      // 7. çµ„åˆ UPDATE SQLï¼ˆéˆå¼ SET èˆ‡ JOINï¼‰
      let updateSets = [];
      for (let i = 0; i < tables.length - 1; i++) {
        const leftTable = tables[i];
        const rightTable = tables[i + 1];
        // å…©è¡¨éƒ½é¸ç‚º select ä¸”æ¬„ä½åŒåæ‰ç”¢ç”Ÿ SET
        leftTable.selectFields.forEach(f => {
          if (rightTable.selectFields.some(ff => ff.fieldName === f.fieldName)) {
            updateSets.push(`    [${leftTable.tableName}].[${f.fieldName}] = [${rightTable.tableName}].[${f.fieldName}]`);
          }
        });
      }

      // éˆå¼ JOIN ON
      let updateJoinClauses = [];
      for (let i = 1; i < tables.length; i++) {
        const leftTable = tables[i - 1];
        const rightTable = tables[i];
        // æ‰¾å‡ºå…©è¡¨éƒ½é¸ç‚º join key ä¸”åŒåçš„æ¬„ä½
        const leftJoinKeys = leftTable.joinKeyFields.map(f => f.fieldName);
        const rightJoinKeys = rightTable.joinKeyFields.map(f => f.fieldName);
        const commonJoinKeys = leftJoinKeys.filter(key => rightJoinKeys.includes(key));
        let joinConds = commonJoinKeys.map(fieldName =>
          `[${leftTable.tableName}].[${fieldName}] = [${rightTable.tableName}].[${fieldName}]`
        ).join(" AND ");
        updateJoinClauses.push(`JOIN [${rightTable.schemaName}].[${rightTable.tableName}]${joinConds ? " ON " + joinConds : ""}`);
      }

      let updateSql = "";
      if (updateSets.length > 0) {
        updateSql = `UPDATE [${tables[0].schemaName}].[${tables[0].tableName}]\nSET\n${updateSets.join(",\n")}\nFROM [${tables[0].schemaName}].[${tables[0].tableName}]\n`;
        if (updateJoinClauses.length > 0) updateSql += updateJoinClauses.join("\n") + "\n";
        if (whereConds.length > 0) updateSql += "WHERE\n  " + whereConds.join("\n  AND ") + "\n";
        updateSql += ";";
      } else {
        updateSql = "-- åªæœ‰æ¯å…©è¡¨éƒ½é¸ç‚º SELECT ä¸”æ¬„ä½åŒåæ‰æœƒç”¢ç”Ÿ SET";
      }

      document.getElementById("updateSql").innerHTML = `<pre>${updateSql}</pre>`;

      // 8. çµ„åˆ INSERT SQLï¼ˆåªç”¢ç”Ÿæ²’æœ‰ join key çš„è¡¨ï¼‰
      let insertSqlHtml = "";
      tables.forEach(table => {
        if (table.joinKeyFields.length === 0 && table.selectFields.length > 0) {
          const fullTableName = `[${table.schemaName}].[${table.tableName}]`;
          const insertColumns = table.selectFields.map(field => `    [${field.fieldName}]`).join(",\n");
          const insertValues = table.selectFields.map(field => `    ? /* ${field.description} */`).join(",\n");
          insertSqlHtml += `<div class="table-section">`;
          insertSqlHtml += `<div class="table-title">â• ${table.schemaName}.${table.tableName}</div>`;
          insertSqlHtml += `<pre>INSERT INTO ${fullTableName}\n(\n${insertColumns}\n)\nVALUES\n(\n${insertValues}\n);</pre>`;
          insertSqlHtml += `</div>`;
        }
      });
      if (!insertSqlHtml) {
        insertSqlHtml = "<pre>-- æœ‰ JOIN KEY ç„¡æ³•ç”¢ç”Ÿ INSERT èªæ³•</pre>";
      }
      document.getElementById("insertSql").innerHTML = insertSqlHtml;



    }

    function getFieldDescription(fieldName, tableName, schemaName) {
      const field = data.find(row => 
        row["æ¬„ä½åç¨±"] === fieldName && 
        row["è³‡æ–™è¡¨åç¨±"] === tableName && 
        row["Schema åç¨±"] === schemaName
      );
      return field ? field["æ¬„ä½èªªæ˜"] : "";
    }

    function showTab(tabName) {
      // éš±è—æ‰€æœ‰ tab
      document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
      document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));

      // é¡¯ç¤ºé¸ä¸­çš„ tab
      document.getElementById(tabName + "Tab").classList.add("active");
      event.target.classList.add("active");
    }

    function copySql(type) {
      const sqlElement = document.getElementById(type + "Sql");
      let text = "";
      
      // æå–æ‰€æœ‰ pre æ¨™ç±¤ä¸­çš„æ–‡å­—
      const preElements = sqlElement.querySelectorAll("pre");
      if (preElements.length > 0) {
        text = Array.from(preElements).map(pre => pre.textContent).join("\n\n");
      } else {
        text = sqlElement.textContent;
      }
      
      navigator.clipboard.writeText(text).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        const originalBg = btn.style.background;
        btn.textContent = "âœ… å·²è¤‡è£½";
        btn.style.background = "#27ae60";
        
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = originalBg;
        }, 2000);
      }).catch(() => {
        // å¦‚æœ clipboard API ä¸å¯ç”¨ï¼Œä½¿ç”¨å‚³çµ±æ–¹æ³•
        const textarea = document.createElement("textarea");
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);
        
        alert("SQL å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
      });
    }

    function downloadSql(type) {
      const sqlElement = document.getElementById(type + "Sql");
      let text = "";
      
      // æå–æ‰€æœ‰ pre æ¨™ç±¤ä¸­çš„æ–‡å­—
      const preElements = sqlElement.querySelectorAll("pre");
      if (preElements.length > 0) {
        text = Array.from(preElements).map(pre => pre.textContent).join("\n\n");
      } else {
        text = sqlElement.textContent;
      }
      
      // å»ºç«‹ä¸€å€‹éš±è—çš„ a æ¨™ç±¤ç”¨æ–¼ä¸‹è¼‰
      const a = document.createElement("a");
      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = `${type}_sql_${new Date().toISOString().slice(0, 10)}.sql`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>

</body>
</html>